import React, { useEffect, useState } from "react";
import { Link, useParams, useNavigate } from "react-router-dom";
import { useFormik } from "formik";
import * as Yup from "yup";
import Axios from "axios";

import DatePicker from "react-datepicker";
import "react-datepicker/dist/react-datepicker.css";

const EditItem = () => {
  const { id } = useParams();
  const navigate = useNavigate();

  const validationSchema = Yup.object().shape({
    platformName: Yup.string().required("Platform Name is required"),
    //inventoryDate: Yup.date().nullable().required("Inventory Date is required"),
    length: Yup.number()
      .min(1, "Length must be greater than 0")
      .required("Length is required"),
    width: Yup.number()
      .min(1, "Width must be greater than 0")
      .required("Width is required"),
    maxSpeed: Yup.number()
      .min(1, "Max Speed must be greater than 0")
      .required("Max Speed is required"),
    minSpeed: Yup.number()
      .min(1, "Min Speed must be greater than 0")
      .required("Min Speed is required"),
    platformType: Yup.array().min(
      1,
      "Please select at least one Platform Type"
    ),
  });

  const [initialValues, setInitialValues] = useState({
    platformName: "",
    inventoryDate: null,
    length: 0,
    width: 0,
    height: 0,
    maxSpeed: 0,
    minSpeed: 0,
    platformType: [],
  });

  const [selectedDate, setSelectedDate] = useState(null);

  useEffect(() => {
    // Fetch the item's data for pre-filling the form
    Axios.get(`http://localhost:3004/platforms/${id}`)
      .then((response) => {
        const data = response.data;
        const formattedDate = data.inventoryDate
          ? new Date(data.inventoryDate.split(".").reverse().join("-")) // Convert "15.04.2022" to "2022-04-15"
          : null;

        setInitialValues({
          platformName: data.platformName,
          inventoryDate: formattedDate,
          length: data.length,
          width: data.width,
          height: data.height,
          maxSpeed: data.maxSpeed,
          minSpeed: data.minSpeed,
          platformType: data.platformType.map((type) => type.name),
        });
        setSelectedDate(formattedDate);
      })
      .catch((error) => {
        console.error("Error fetching item data:", error);
      });
  }, [id]);

  const formik = useFormik({
    initialValues,
    validationSchema,
    onSubmit: async (values) => {
      try {
        const platformTypeArray = values.platformType.map((name, index) => ({
          id: index + 1,
          name,
        }));

        await Axios.put(`http://localhost:3004/platforms/${id}`, {
          ...values,
          platformType: platformTypeArray,
        });

        navigate(`/item/${id}`);
      } catch (error) {
        console.error("Error updating item:", error);
      }
    },
  });

  const { values, touched, errors, handleChange, handleBlur, handleSubmit } =
    formik;

  return (
    <div className="bg-white shadow-md p-6 rounded-lg w-96 mx-auto">
      <h2 className="text-2xl font-semibold mb-4">Edit Platform</h2>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label
            className="block text-gray-700 font-semibold"
            htmlFor="platformName"
          >
            Platform Name
          </label>
          <input
            type="text"
            id="platformName"
            name="platformName"
            value={values.platformName}
            onChange={handleChange}
            onBlur={handleBlur}
            className="w-full p-2 border rounded focus:ring focus:ring-blue-300"
          />
          {touched.platformName && errors.platformName && (
            <p className="text-red-500">{errors.platformName}</p>
          )}
        </div>

        <div>
          <label
            className="block text-gray-700 font-semibold"
            htmlFor="inventoryDate"
          >
            Inventory Date
          </label>
          <DatePicker
            selected={selectedDate}
            dateFormat="dd.MM.yyyy" // Corrected date format
            id="inventoryDate"
            name="inventoryDate"
            onChange={(date) => {
              console.log(date);
              setSelectedDate(date);
            }}
            onBlur={handleBlur}
            className="w-full p-2 border rounded focus:ring focus:ring-blue-300"
          />

          
          {touched.inventoryDate && errors.inventoryDate && (
            <p className="text-red-500">{errors.inventoryDate}</p>
          )}
        </div>

        {/* Rest of the form fields... */}

        <div className="flex justify-center space-x-2">
          <button
            type="submit"
            className="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
          >
            Save Changes
          </button>
          <Link
            to={`/item/${id}`}
            className="bg-blue-500 text-white py-2 px-4 rounded hover-bg-blue-600"
          >
            Cancel This P
          </Link>
        </div>
      </form>
    </div>
  );
};

export default EditItem;
